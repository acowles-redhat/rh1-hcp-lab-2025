= Configure the Hosted Cluster

One of the primary uses of a hosted control planes cluster is to provide multitenancy for individual users to have their own clusters with dedicated resources that cannot be infringed upon by other users. In this section we will demonstrate how our hosted cluster functions just like any other deployed cluster environment by configuring authentication for ourselves, granting ourselves cluster permissions, and logging into the hosted cluster with those credentials.

. *Goals*

* Configure authentication for a regular user.
* Test the authentication once the cluster is configured.

[[local-auth]]
== Configure Authentication

NOTE: In this section we will make use of the Show Room terminal provided to the left to perform some command line actions.


=== Create a User

. Start this lab section by clicking on the *Console URL* hyperlink available in the *Details* section of the *my-hosted-cluster* overview page.
+
image::configure/console_url.png[link=self, window=blank, width=100%]
+ 
NOTE: You may still be logged in from the previous section, if not you can review the *kubeadmin* username and associated password and use those to login.

. A new tab will open and bring up the Openshift console Overview. On the left-side menu click on *User Management* and *Users* when it drops down.
+
image::configure/overview_users.png[link=self, window=blank, width=100%]

. A new page will open that is mostly blank. As this is a newly deployed cluster, there are no Identity Providers (IDP) configured. Click on the blue button that says *Add IDP*.
+
image::configure/no_idp.png[link=self, window=blank, width=100%]

. A new page will load providing *OAuth details* and in the bottom section called *Identity providers* you have the option to select the *Add* drop-down box and see the number of identity providers available for Red Hat OpenShift. Popular choices include GitHub authentication, LDAP, and Google authentication, explore the benefits and detriments of each when configuring for production. For a simple deployment in our lab we are going to use the *HTPasswd* method. Select it from the dropdown menu.
+
image::configure/add_idp_htpasswd.png[link=self, window=blank, width=100%]

. We will be presented with a page where we can either upload an HTPasswd file, or paste in the text of the file. Before doing that, we must create one.
+
image::configure/create_htpasswd_blank.png[link=self, window=blank, width=100%]

. In your Showroom terminal copy and paste the following syntax and press the *Enter* key.
+
[source,sh,role=execute,subs="attributes"]
----
htpasswd -c -B -b myuser.htpasswd myuser R3dHat1!
----
+
image::configure/terminal_create_htpasswd.png[link=self, window=blank, width=100%]

. We can use the *cat* command to list the contents of the newly created htpasswd file. Use the syntax below to view the file's contents. It will include our username, and the hashed value of the password we created.
+
[source,sh,role=execute,subs="attributes"]
----
cat myuser.htpasswd
----
+
image::configure/cat_htpasswd.png[link=self, window=blank, width=100%]

. Now we need to create a secret that holds this value in our hosted cluster. Returning to our browser window we can click on the *kube:admin* menu in the top right, and select the option for *Copy login command*.
+
image::configure/copy_login_command.png[link=self, window=blank, width=100%]

. A new screen will appear with a link for us to *Display Token*, click on this link to display the login command we need to authenticate in our terminal.
+
image::configure/display_token.png[link=self, window=blank, width=100%]

. Copy the syntax from below the *Log in with this token* section.
+
image::configure/login_token.png[link=self, window=blank, width=100%]

. Paste the syntax into your Showroom terminal and press the Enter key. You will be prompted to accept a security certificate, when you do you will be logged into the cluster via CLI.
+
image::configure/terminal_cluster_login.png[link=self, window=blank, width=100%]

. Now we can create the secret in the cluster we need with the following syntax.
+
[source,sh,role=execute,subs="attributes"]
----
oc create secret generic htpass-secret --from-file=htpasswd=myuser.htpasswd -n openshift-config 
----
+
image::configure/secret_created.png[link=self, window=blank, width=100%]

. Highlight the line where we used the cat command to display the contents of the myuser.htpasswd file that was written to standard out, right-click to copy and then paste it into the text block in our OpenShift console tab. When complete, click on the blue *add* button to create an Identity Provider.
+
image::configure/paste_htpasswd.png[link=self, window=blank, width=100%]

. You will be returned to the *OAuth details* page of the cluster, and you will now see a message about a new identity provider being added, and you will see our htpasswd identity provider listed at the bottom.
+
image::configure/new_idp_added.png[link=self, window=blank, width=100%]


=== Create a Group

. On the left-side menu click on *User Management* and select *Groups*. You will notice that there are no groups currently defined, but you can create one with the blue *Create Group* button in the upper right corner.
+
image::configure/create_group.png[link=self, window=blank, width=100%]

. You will be taken to *Create Group* dialog where you can create the group name *hosted_cluster_admins* and you can add our *myuser* user account as one of it's members. When you are finished, click the blue *Create* button at the bottom.
+
image::configure/create_group_yaml.png[link=self, window=blank, width=100%]

. You will be returned to the *Group details* page where it will list our *hosted_cluster_admins* group, and the *myuser* user as a member of the group. 
+
image::configure/group_details.png[link=self, window=blank, width=100%]


=== Create Cluster RoleBindings

. In order to determine what permissions our group and our user as a member of that group has, we will need to configure cluster rolebindings. Click on the *RoleBindings* menu found at the top of the page.
+
image::configure/group_details_rolebindings.png[link=self, window=blank, width=100%]
+
NOTE: RoleBindings can also be created from the left-side menu, but creating them from within the group context sets several of the group options automatically for us.

. The page will load displaying that there are currently no rolebindings found. Click the blue *Create binding* button to configure one.
+
image::configure/no_rolebindings_found.png[link=self, window=blank, width=100%]

. You will be presented with the page titled *Create RoleBinding*
+
. Fill out the form with the following values:
.. *Binding type:* Cluster-wide role binding (ClusterRoleBinding)
.. *Name:* my_cluster_admins
.. *Role name:* cluster-admin
+
. Click on *Create* when you are finished filling out the options.
+
image::configure/create_rolebinding.png[link=self, window=blank, width=100%]

. You will be returned to the *ClusterRoleBinding details* page where you can view your rolebinding.
+
image::configure/cluster_rolebinding_details.png[link=self, window=blank, width=100%]

. On the left-side menu click on *User Management* and select *Users* from the drop-down list. You might expect to see our newly created *myuser* account listed, but instead you are greeted with the following screen.
+
image::configure/no_users_found.png[link=self, window=blank, width=100%]

. As the message on this screen says, users will not be listed until they login for the first time. When you are ready to test our configuration, click at the top of the screen where it shows the current user *kube:admin*, and select the option to *Log out* from the drop-down menu. You will be returned to a blank white screen when logged out, close the tab.
+
image::configure/cluster_log_out.png[link=self, window=blank, width=100%]


[[test-auth]]
== Test Authentication

IMPORTANT: You may need to clear your browser cache and close out your sessions completely in order to proceed with this portion of the lab. If you do so you may be prompted with the security prompts for the lab when you login again. You can find the URL to login and the credentials for your main lab environment in the Introduction section of this lab.

. Log into your hosting cluster using the *admin* account and password provided in the lab guide.
+
image::deploy/console_login.png[link=self, window=blank, width=100%]

. Upon login the *Cluster list* will be displayed for you. Click on *my-hosted-cluster* to launch it's details screen.
+
image::deploy/cluster_list.png[link=self, window=blank, width=100%]

. On the *my-hosted-cluster* overview page, scroll down and click on the *Console URL* to launch a new tab with the OpenShift console.
+
image::configure/console_url.png[link=self, window=blank, width=100%]

. Log into the cluster with our newly created *myuser* account and the password that we created *R3dHat1!*
+
image::configure/cluster_user_login.png[link=self, window=blank, width=100%]

<RESUME HERE TOMRROW>
